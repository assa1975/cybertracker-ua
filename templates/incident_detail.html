{% extends "base.html" %}
{% block title %}{{ incident.title[:50] }} | Кібертрекер UA{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Дашборд</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('incidents_list') }}">Інциденти</a></li>
        <li class="breadcrumb-item active">{{ incident.title[:40] }}...</li>
    </ol>
</nav>

<div class="card shadow-sm">
    <div class="card-header bg-ua-blue text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-shield-exclamation"></i> Деталі інциденту</h4>
        {% if incident.severity %}
            <span class="badge severity-{{ incident.severity|severity_class }} fs-6">{{ incident.severity }}</span>
        {% endif %}
    </div>
    <div class="card-body">
        <h3>{{ incident.title }}</h3>
        {% if incident.title_uk and incident.title_uk != incident.title %}
        <h4 class="text-primary"><i class="bi bi-translate"></i> {{ incident.title_uk }}</h4>
        {% endif %}

        <!-- Metadata badges -->
        <div class="mb-3">
            {% if incident.attack_type %}
                <span class="badge bg-info me-1"><i class="bi bi-lightning-fill"></i> {{ incident.attack_type }}</span>
            {% endif %}
            {% if incident.target_sector %}
                <span class="badge bg-primary me-1"><i class="bi bi-building"></i> {{ incident.target_sector }}</span>
            {% endif %}
            {% if incident.source %}
                <span class="badge bg-secondary me-1"><i class="bi bi-newspaper"></i> {{ incident.source }}</span>
            {% endif %}
        </div>

        <!-- Details table -->
        <table class="table table-bordered">
            <tr>
                <th style="width: 200px;"><i class="bi bi-calendar3"></i> Дата</th>
                <td>{{ incident.date.strftime('%d %B %Y, %H:%M') if incident.date else '—' }}</td>
            </tr>
            {% if incident.threat_actor %}
            <tr>
                <th><i class="bi bi-person-fill-exclamation"></i> Загрозливий актор</th>
                <td><span class="text-danger fw-bold">{{ incident.threat_actor }}</span></td>
            </tr>
            {% endif %}
            {% if incident.mitre_technique_id %}
            <tr>
                <th><i class="bi bi-diagram-3"></i> MITRE ATT&CK</th>
                <td>
                    <a href="https://attack.mitre.org/techniques/{{ incident.mitre_technique_id }}/"
                       target="_blank" rel="noopener noreferrer">
                        {{ incident.mitre_technique_id }}
                        {% if technique_name %} &mdash; {{ technique_name }}{% endif %}
                    </a>
                </td>
            </tr>
            {% endif %}
            {% if incident.source_url %}
            <tr>
                <th><i class="bi bi-link-45deg"></i> Джерело</th>
                <td>
                    <a href="{{ incident.source_url }}" target="_blank" rel="noopener noreferrer">
                        {{ incident.source_url[:80] }}{% if incident.source_url|length > 80 %}...{% endif %}
                    </a>
                </td>
            </tr>
            {% endif %}
            <tr>
                <th><i class="bi bi-clock"></i> Додано в трекер</th>
                <td>{{ incident.created_at.strftime('%d.%m.%Y %H:%M') if incident.created_at else '—' }}</td>
            </tr>
        </table>

        <!-- Images from article -->
        {% if incident.images %}
        <div class="mt-4">
            <h5><i class="bi bi-images"></i> Зображення зі статті</h5>
            <div class="row g-3">
                {% for img_path in incident.images | parse_images %}
                <div class="col-md-6 col-lg-4">
                    <img src="{{ url_for('article_image', path=img_path) }}"
                         class="img-fluid rounded shadow-sm"
                         alt="Image from article"
                         style="max-height: 300px; width: 100%; object-fit: contain;">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Full text (Ukrainian translation first) -->
        {% if incident.full_text_uk %}
        <div class="mt-4">
            <h5><i class="bi bi-translate"></i> Повний текст (українською)</h5>
            <div class="bg-light p-3 rounded border-start border-primary border-3" style="white-space: pre-line;">{{ incident.full_text_uk }}</div>
        </div>
        {% elif incident.description_uk %}
        <div class="mt-4">
            <h5><i class="bi bi-translate"></i> Опис (українською)</h5>
            <div class="bg-light p-3 rounded border-start border-primary border-3">
                {{ incident.description_uk }}
            </div>
        </div>
        {% endif %}

        <!-- Full text original -->
        {% if incident.full_text %}
        <div class="mt-4">
            <h5><i class="bi bi-text-paragraph"></i> Повний текст (оригінал)</h5>
            <details>
                <summary class="btn btn-outline-secondary btn-sm mb-2">Показати оригінал</summary>
                <div class="bg-light p-3 rounded" style="white-space: pre-line;">{{ incident.full_text }}</div>
            </details>
        </div>
        {% elif incident.description %}
        <div class="mt-4">
            <h5><i class="bi bi-text-paragraph"></i> Опис (оригінал)</h5>
            <div class="bg-light p-3 rounded">
                {{ incident.description }}
            </div>
        </div>
        {% endif %}

        <!-- IOC Indicators -->
        {% if incident.ioc_indicators %}
        <div class="mt-4">
            <h5><i class="bi bi-fingerprint"></i> IOC Індикатори</h5>
            <pre class="bg-dark text-success p-3 rounded"><code>{{ incident.ioc_indicators }}</code></pre>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3">
    <a href="{{ url_for('incidents_list') }}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left"></i> Назад до списку
    </a>
</div>
{% endblock %}
