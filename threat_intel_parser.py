"""
Threat Intelligence Parser.
Imports structured data about threat actors and organizations
from the APT28/GRU investigation (The Insider, 2025).
Source: D:\\26165_apt28.odt
"""

import json
import logging
from datetime import datetime, timezone

from sqlalchemy.exc import IntegrityError

from models import ThreatPerson, ThreatOrganization
from database import get_session

logger = logging.getLogger(__name__)

SOURCE_URL = 'https://theins.ru/inv/281701'

# ============================================================
# Structured data extracted from the ODT document
# ============================================================

PERSONS_DATA = [
    {
        'name': 'Тим Стигал',
        'aliases': 'Данила Магомедов',
        'role': 'Куратор хакерів',
        'organization': 'В/ч 29155, ДВКР ФСБ',
        'country': 'Росія',
        'description': (
            'Етнічний чеченець, блогер з Дагестану. Автор книги про торгівлю на Форексі. '
            'Був завербований ДВКР ФСБ, отримав паспорт прикриття на ім\'я "Данила Магомедов" '
            'з того ж діапазону номерів, що й паспорти отруювачів Скрипаля. '
            'Організовував інформаційні провокації: фейкові акаунти Anonymous Poland, Anonymous Bulgaria; '
            'злив даних WADA, Boeing, поліції Детройта; дискредитація Bellingcat; '
            'завербував журналістку Діляну Гайтанджієву; організував провокації проти Зеленського '
            'через фейкових "азовців"; координував графіті-кампанію в українських містах. '
            'Звільнений "за станом здоров\'я" у 2021 році через конфлікт з керівництвом.'
        ),
        'operations': json.dumps([
            'Злом банку QNB (Катар, 2016)',
            'Дискредитація Bellingcat через фейкові акаунти',
            'Операція Anonymous Poland (@anonpl, @anon_pl20)',
            'Операція Anonymous Bulgaria — злив переписки посольства Азербайджану',
            'Вербовка журналістки Діляни Гайтанджієвої',
            'Провокації "Азов проти Зеленського" — графіті-кампанія',
            'Організація підпалу будинку Ігоря Жовкви (2021)',
        ], ensure_ascii=False),
        'status': 'Звільнений (2021)',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/stigal.jpg',
    },
    {
        'name': 'Алексєй Строганов',
        'aliases': 'Флінт',
        'role': 'Хакер-кардер',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Кардер, засуджений у 2006 за шахрайство з картками (6 років, вийшов через 2). '
            'Після звільнення став "експертом з кібербезпеки", захищав банки та платіжні системи. '
            'Губернатор Санкт-Петербурга Бєглов вручав йому грамоту. '
            'Паралельно продовжував шахрайську діяльність під керівництвом ДВКР ФСБ. '
            'Арештований повторно у 2021 — по кримінальній справі проходить 26 осіб. '
            'Заявив у суді про роботу на спецслужби та пред\'явив грамоту за підписом директора ФСБ.'
        ),
        'operations': json.dumps([
            'Банківські шахрайства з картками (2014-2020)',
            'Хакерські операції в інтересах ГРУ',
        ], ensure_ascii=False),
        'status': 'Арештований (2021)',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Євгеній Башев',
        'aliases': '',
        'role': 'Хакер, зв\'язок з ФСБ',
        'organization': 'В/ч 29155, «Імпульс»',
        'country': 'Росія',
        'description': (
            'Працював на ДВКР ФСБ. Власник компанії «Імпульс» у Ростові — '
            'прокладка для хакерських операцій ГРУ. '
            'Контролював сервер «Егеон» в Ростові. '
            'Зв\'язуючий між хакерами та ФСБ після відходу Стигала.'
        ),
        'operations': json.dumps([
            'Управління компанією-прокладкою «Імпульс»',
            'Контроль серверу «Егеон»',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Ігор Ворошилов',
        'aliases': '',
        'role': 'Хакер',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': 'Хакер ГРУ. Привів Євгенія Башева в команду підрозділу 29155.',
        'operations': json.dumps([
            'Рекрутинг хакерів для В/ч 29155',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Юрій Денисов',
        'aliases': 'Юрій C++, Юрій C#, Юрій Бази даних, Юрій Лукін, Юрій Дудін, Юрій Карпов, Юрій Сергеєв',
        'role': 'Куратор-ветеран',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Полковник ГРУ з 27-річною вислугою. Використовував різні імена прикриття: '
            '"Дудін" (поїздки в Німеччину, Бельгію, Нідерланди, 2016), '
            '"Лукін" (Туреччина, Азербайджан, 2013-2014), "Карпов", "Сергеєв". '
            'Мав базові IT-навички (підписка на хакерські Telegram-групи). '
            'Публічно розкривав інформацію про себе в Telegram-чатах. '
            'Використовував один номер телефону для бронювання під усіма іменами. '
            'Відправлений у ПВК в Білорусь.'
        ),
        'operations': json.dumps([
            'Поїздки по Європі під прикриттям (2013-2016)',
            'Кібероперації проти України (2021-2022)',
            'Підготовка до повномасштабного вторгнення',
        ], ensure_ascii=False),
        'status': 'Переведений у ПВК (Білорусь)',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/denisov.jpg',
    },
    {
        'name': 'Роман Пунтус',
        'aliases': 'Роман Панов',
        'role': 'Керівник хакерського відділу',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Ветеран операцій В/ч 29155. Подорожував під прикриттям "Роман Панов". '
            'Після відходу Стигала став головним гравцем у хакерському відділі (з 2021). '
            'Заснував компанію «Егеон-Імпульс» (ІПН 9731116423), оформлену на Дар\'ю Кулішову. '
            'Фігурував у розслідуваннях про Гаванський синдром та теракти в Афганістані. '
            'Залишив незахищеним сервер «Егеон» з відкритими портами. '
            'У лютому 2025 сервер був виявлений блогером з кібербезпеки.'
        ),
        'operations': json.dumps([
            'Керівництво хакерським відділом В/ч 29155 (з 2021)',
            'Кібератаки на українські сайти (січень 2022)',
            'Атаки на інфраструктуру Естонії, Чехії, Польщі',
            'Управління сервером «Егеон»',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Іван Касьяненко',
        'aliases': '',
        'role': 'Заступник начальника В/ч 29155',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Заступник начальника підрозділу 29155. '
            'Фігурував у розслідуваннях The Insider, пов\'язаних '
            'з Гаванським синдромом та терактами в Афганістані. '
            'Контролював Денисова та Пунтуса.'
        ),
        'operations': json.dumps([
            'Гаванський синдром',
            'Теракти в Афганістані',
            'Кураторство хакерського відділу',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Віталій Шевченко',
        'aliases': 'Єлізар Крітський',
        'role': 'Хакер ("Орля")',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Перший завербований з групи "орлят" — студентів Воронезького '
            'Військового навчально-наукового центру ВПС. '
            'Працевлаштований у Міноборони з 2020 року. '
            'У телефонах знайомих підписаний як "хакер Єлізар". '
            'Відіграв вирішальну роль у зламі Міноборони Естонії та інших '
            'держустанов країни у 2020 році. '
            'Покинув команду наприкінці 2021 через конфлікт з Пунтусом.'
        ),
        'operations': json.dumps([
            'Злам Міноборони Естонії (2020)',
            'Злам державних установ Естонії',
        ], ensure_ascii=False),
        'status': 'Звільнився (2021)',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Ніколай Корчагін',
        'aliases': '',
        'role': 'Хакер ("Орля")',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Студент-хакер з Воронезького ВУНЦ ВПС. '
            'Завербований після хакатону Capture-The-Flag. '
            'Фігурує на фото з хакатону та групових фото з іншими хакерами 29155.'
        ),
        'operations': json.dumps([
            'Кібероперації В/ч 29155',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/korchagin.jpg',
    },
    {
        'name': 'Владислав Боровков',
        'aliases': '',
        'role': 'Хакер',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': 'Хакер ГРУ з підрозділу 29155.',
        'operations': json.dumps([
            'Кібероперації В/ч 29155',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/borovkov.jpg',
    },
    {
        'name': 'Дмитро Воронов',
        'aliases': '',
        'role': 'Хакер ("Орля")',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': 'Студент-хакер з Воронезького ВУНЦ ВПС, завербований після хакатону.',
        'operations': json.dumps([
            'Кібероперації В/ч 29155',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Денис Денисенко',
        'aliases': '',
        'role': 'Хакер ("Орля")',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': 'Студент-хакер з Воронезького ВУНЦ ВПС, завербований після хакатону.',
        'operations': json.dumps([
            'Кібероперації В/ч 29155',
        ], ensure_ascii=False),
        'status': 'Активний',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/denisenko.jpg',
    },
    {
        'name': 'Андрій Аверьянов',
        'aliases': '',
        'role': 'Генерал, керівник В/ч 29155',
        'organization': 'В/ч 29155',
        'country': 'Росія',
        'description': (
            'Керівник військової частини 29155. Під його протекцією існує підрозділ '
            'навіть після численних провалів. Доручив створення хакерського відділу '
            'Стигалу, Пунтусу та Денисову. Пішов на підвищення, але продовжує '
            'контролювати підрозділ. Зайнятий африканськими проектами '
            'та організацією саботажних операцій.'
        ),
        'operations': json.dumps([
            'Керівництво В/ч 29155',
            'Отруєння Скрипалів (Солсбері)',
            'Отруєння Ємельяна Гебрева (Болгарія)',
            'Вибухи військових складів (Болгарія, Чехія)',
            'Африканські операції',
        ], ensure_ascii=False),
        'status': 'Активний (підвищення)',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/averyanov.jpg',
    },
    {
        'name': 'Діляна Гайтанджієва',
        'aliases': '',
        'role': 'Завербована журналістка',
        'organization': 'ArmsWatch',
        'country': 'Болгарія',
        'description': (
            'Болгарська журналістка, працювала з ГРУ імовірно з 2016 року. '
            'Публікувала "розслідування" на основі зламаних ГРУ матеріалів. '
            'Звільнена з газети "Труд" через юридичні наслідки. '
            'У 2018 зробила репортаж про неіснуючі "американські біолабораторії" в Грузії. '
            'У 2019 зареєструвала ArmsWatch.com для регулярної публікації зливів 29155. '
            'Публікації The Serbia Files (2019) спричинили дипломатичний скандал з Сербією.'
        ),
        'operations': json.dumps([
            'Публікація зливу переписки посольства Азербайджану (2017)',
            'Репортаж про "біолабораторії" в Грузії (2018)',
            'The Serbia Files — злив через ArmsWatch (2019)',
            'Дезінформаційна підтримка операцій 29155',
        ], ensure_ascii=False),
        'status': 'Активна',
        'source_url': SOURCE_URL,
        'photo_url': '/static/images/persons/gaytandzhieva.jpg',
    },
    {
        'name': 'Дар\'я Кулішова',
        'aliases': '',
        'role': 'Бухгалтер / підставна особа',
        'organization': '«Егеон-Імпульс»',
        'country': 'Росія',
        'description': (
            'Бухгалтер, на яку оформлена компанія «Егеон-Імпульс» (ІПН 9731116423). '
            'Коханка Романа Пунтуса. У листопаді 2023 народила сина Матвія Романовича. '
            'У 2024 зареєструвала торгову марку "Сабраж Саботаж" на «Егеон-Імпульс».'
        ),
        'operations': json.dumps([
            'Оформлення компанії «Егеон-Імпульс»',
            'Реєстрація торгової марки "Сабраж Саботаж"',
        ], ensure_ascii=False),
        'status': 'Активна',
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Олександр Обрадович',
        'aliases': '',
        'role': 'Агент / джерело',
        'organization': '',
        'country': 'Сербія',
        'description': (
            'Передав витоки ГРУ, пов\'язані з сербською компанією Krusik '
            'та продажем зброї. Його інформація була опублікована через ArmsWatch '
            'і спричинила дипломатичний скандал між Росією та Сербією.'
        ),
        'operations': json.dumps([
            'Передача витоків по справі Krusik (2019)',
        ], ensure_ascii=False),
        'status': 'Невідомий',
        'source_url': SOURCE_URL,
    },
]

ORGANIZATIONS_DATA = [
    {
        'name': 'В/ч 26165',
        'org_type': 'Військова частина ГРУ',
        'aliases': 'APT28, Fancy Bear',
        'country': 'Росія',
        'parent_org': 'ГРУ ГШ ЗС РФ',
        'description': (
            'Хакерське підрозділення ГРУ, відоме як APT28 або Fancy Bear. '
            'Розташоване на Комсомольському проспекті, Москва. '
            'Відповідальне за злам серверів Хіларі Клінтон, Еммануеля Макрона, '
            'WADA, різних міжнародних організацій. '
            'Вперше ідентифіковане The Insider у 2017 році.'
        ),
        'known_operations': json.dumps([
            'Злам серверів Демократичної партії США (2016)',
            'Злам Еммануеля Макрона',
            'Злам WADA (2016)',
            'Атаки на міжнародні організації',
        ], ensure_ascii=False),
        'members_count': None,
        'source_url': SOURCE_URL,
    },
    {
        'name': 'В/ч 74455',
        'org_type': 'Військова частина ГРУ',
        'aliases': 'Sandworm, APT44',
        'country': 'Росія',
        'parent_org': 'ГРУ ГШ ЗС РФ',
        'description': (
            'Хакерське підрозділення ГРУ, відоме як Sandworm або APT44. '
            'Створило найруйнівніший вірус NotPetya. '
            'Відключало електростанції в Україні (2015-2017). '
            'Атакувало військові об\'єкти НАТО.'
        ),
        'known_operations': json.dumps([
            'Створення вірусу NotPetya',
            'Відключення електростанцій в Україні (2015-2017)',
            'Атаки на об\'єкти НАТО',
            'Вірус Industroyer',
        ], ensure_ascii=False),
        'members_count': None,
        'source_url': SOURCE_URL,
    },
    {
        'name': 'В/ч 29155',
        'org_type': 'Військова частина ГРУ',
        'aliases': '',
        'country': 'Росія',
        'parent_org': 'ГРУ ГШ ЗС РФ',
        'description': (
            'Підрозділення ГРУ, відоме отруєннями, диверсіями та хакерськими операціями. '
            'Керівник — генерал Андрій Аверьянов. '
            'Відповідальне за отруєння Скрипалів (Солсбері), Ємельяна Гебрева (Болгарія), '
            'вибухи військових складів у Болгарії та Чехії. '
            'Хакерський відділ створений ~2014, вербував кардерів та студентів. '
            'У січні 2022 зламав українські державні сайти перед повномасштабним вторгненням. '
            'Атакував інфраструктуру Естонії, Чехії, Польщі, Молдови та інших країн.'
        ),
        'known_operations': json.dumps([
            'Отруєння Скрипалів (Солсбері, 2018)',
            'Отруєння Ємельяна Гебрева (Болгарія)',
            'Вибухи військових складів (Болгарія, Чехія)',
            'Злам банку QNB (Катар, 2016)',
            'Злам Міноборони Естонії (2020)',
            'Дефейс українських сайтів (січень 2022)',
            'Кібератаки на інфраструктуру Європи',
            'Операція "Азов проти Зеленського"',
            'Підпал будинку Ігоря Жовкви (2021)',
        ], ensure_ascii=False),
        'members_count': 16,
        'source_url': SOURCE_URL,
    },
    {
        'name': 'ДВКР ФСБ',
        'org_type': 'Спецслужба',
        'aliases': 'Департамент військової контррозвідки ФСБ',
        'country': 'Росія',
        'parent_org': 'ФСБ РФ',
        'description': (
            'Департамент військової контррозвідки ФСБ. '
            'Контролює ГРУ через прикомандированих співробітників. '
            'Мав тісні контакти з хакерами-шахраями (кардерами). '
            'Сприяв звільненню Строганова ("Флінта") з в\'язниці. '
            'Тім Стигал був прикомандирований від ДВКР до В/ч 29155.'
        ),
        'known_operations': json.dumps([
            'Контроль над ГРУ',
            'Вербовка та контроль хакерів-кардерів',
            'Зв\'язок з В/ч 29155 через Стигала та Башева',
        ], ensure_ascii=False),
        'members_count': None,
        'source_url': SOURCE_URL,
    },
    {
        'name': '«Імпульс»',
        'org_type': 'Компанія-прокладка',
        'aliases': '',
        'country': 'Росія',
        'parent_org': 'В/ч 29155',
        'description': (
            'Компанія Євгенія Башева в Ростові. '
            'Виконувала роль прокладки для хакерських операцій ГРУ. '
            'Дозволяла проводити операції через компанії, '
            'формально не пов\'язані з державою. '
            'Контролювала сервер «Егеон» у Ростові.'
        ),
        'known_operations': json.dumps([
            'Прикриття хакерських операцій ГРУ',
            'Управління сервером «Егеон»',
        ], ensure_ascii=False),
        'members_count': None,
        'source_url': SOURCE_URL,
    },
    {
        'name': '«Егеон-Імпульс»',
        'org_type': 'Компанія-прокладка',
        'aliases': 'ІПН 9731116423',
        'country': 'Росія',
        'parent_org': 'В/ч 29155',
        'description': (
            'Компанія Романа Пунтуса, оформлена на Дар\'ю Кулішову. '
            'Назва — відсилка до серверу «Егеон» та компанії «Імпульс» Башева. '
            'У 2024 зареєстрована торгова марка "Сабраж Саботаж".'
        ),
        'known_operations': json.dumps([
            'Прикриття хакерських операцій',
            'Виробництво коптерів (програма "УПС")',
        ], ensure_ascii=False),
        'members_count': None,
        'source_url': SOURCE_URL,
    },
    {
        'name': 'Anonymous Poland',
        'org_type': 'Фейковий акаунт',
        'aliases': '@anonpl, @anon_pl20, @anpoland',
        'country': '',
        'parent_org': 'В/ч 29155',
        'description': (
            'Фейкові Twitter-акаунти, створені командою Стигала для операцій інформаційного впливу. '
            'Використовувались для зливу зламаних даних: файли поліції Детройта, '
            'документи Boeing KC-10, дані паралімпійської збірної США та WADA. '
            'Деякі зливи раніше приписувались FancyBear (В/ч 26165).'
        ),
        'known_operations': json.dumps([
            'Злив даних поліції Детройта',
            'Злив документів Boeing KC-10',
            'Злив даних паралімпійської збірної США',
            'Злив даних WADA (2016)',
            'Публікація даних кредитних карток під виглядом Bellingcat',
        ], ensure_ascii=False),
        'members_count': None,
        'source_url': SOURCE_URL,
    },
    {
        'name': 'ArmsWatch',
        'org_type': 'Медіа-платформа',
        'aliases': 'armswatch.com',
        'country': 'Болгарія',
        'parent_org': 'В/ч 29155',
        'description': (
            'Веб-сайт, зареєстрований Діляною Гайтанджієвою у 2019 році '
            'для публікації зламаних підрозділом 29155 масивів даних. '
            'Публікації часто спрямовані на дискредитацію журналістських розслідувань '
            'про діяльність В/ч 29155. '
            'Опублікував серію The Serbia Files (2019), що спричинила '
            'дипломатичний скандал між Росією та Сербією.'
        ),
        'known_operations': json.dumps([
            'The Serbia Files (2019)',
            'Дискредитація розслідувань про Скрипалів та Гебрева',
            'Регулярна публікація зливів 29155',
        ], ensure_ascii=False),
        'members_count': 1,
        'source_url': SOURCE_URL,
    },
]


def import_threat_intel():
    """
    Import all threat actors and organizations into DB.
    Returns dict with import stats.
    """
    session = get_session()
    persons_added = 0
    orgs_added = 0

    try:
        # Import persons
        for data in PERSONS_DATA:
            exists = session.query(ThreatPerson).filter_by(
                name=data['name']
            ).first()
            if exists:
                # Update existing record
                for key, value in data.items():
                    setattr(exists, key, value)
                logger.info(f"Updated person: {data['name']}")
            else:
                person = ThreatPerson(**data)
                session.add(person)
                persons_added += 1
                logger.info(f"Added person: {data['name']}")

        # Import organizations
        for data in ORGANIZATIONS_DATA:
            exists = session.query(ThreatOrganization).filter_by(
                name=data['name']
            ).first()
            if exists:
                for key, value in data.items():
                    setattr(exists, key, value)
                logger.info(f"Updated org: {data['name']}")
            else:
                org = ThreatOrganization(**data)
                session.add(org)
                orgs_added += 1
                logger.info(f"Added org: {data['name']}")

        session.commit()
        logger.info(f"Import complete: {persons_added} persons, {orgs_added} orgs")

    except Exception as e:
        session.rollback()
        logger.error(f"Import failed: {e}")
        raise
    finally:
        session.close()

    return {
        'persons_added': persons_added,
        'orgs_added': orgs_added,
        'total_persons': len(PERSONS_DATA),
        'total_orgs': len(ORGANIZATIONS_DATA),
    }
